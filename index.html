<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D World Viewer - File Loader</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; color: #fff; font-family: sans-serif; }
        #container { display: flex; height: 100vh; width: 100vw; }
        
        /* ã‚¨ãƒ‡ã‚£ã‚¿ã‚¨ãƒªã‚¢ */
        #editor-pane { width: 350px; background: #1e1e1e; display: flex; flex-direction: column; border-right: 1px solid #444; z-index: 10; transition: transform 0.3s ease; }
        
        /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
        .toolbar { padding: 10px; background: #252526; display: flex; flex-wrap: wrap; gap: 5px; align-items: center; }
        .toolbar button, .toolbar label { 
            background: #3a3a3a; color: white; border: 1px solid #555; padding: 5px 10px; 
            cursor: pointer; border-radius: 4px; font-size: 12px; display: inline-block; text-align: center;
        }
        .toolbar button.run { background: #0e639c; flex-grow: 1; font-weight: bold; }
        
        /* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ï¼ˆè¦‹ãŸç›®ã‚’ãƒœã‚¿ãƒ³ã«ã™ã‚‹ãŸã‚inputè‡ªä½“ã¯éš ã™ï¼‰ */
        .file-label { background: #444 !important; border-color: #666 !important; }
        
        /* ã‚¹ãƒ­ãƒƒãƒˆ */
        .slots { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; padding: 5px; background: #2d2d2d; }
        .slot-btn { font-size: 9px; padding: 4px; border: none; cursor: pointer; color: #fff; border-radius: 2px; }
        .save { background: #5a3e3e; } .load { background: #3e5a46; }
        
        #code-editor { flex-grow: 1; background: #1e1e1e; color: #d4d4d4; border: none; padding: 10px; font-family: monospace; font-size: 13px; outline: none; resize: none; white-space: pre; overflow-x: auto; }
        #viewer-pane { flex-grow: 1; position: relative; }
        
        /* å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ */
        body.fullscreen-mode #editor-pane { transform: translateX(-350px); width: 0; min-width: 0; }
        #close-btn { position: absolute; top: 15px; left: 15px; width: 40px; height: 40px; background: rgba(255,0,0,0.6); color: white; border: none; border-radius: 50%; font-size: 20px; cursor: pointer; display: none; z-index: 100; align-items: center; justify-content: center; }
        body.fullscreen-mode #close-btn { display: flex; }
    </style>
    
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/utils/WebVR.js"></script>
</head>
<body>

<div id="container">
    <div id="editor-pane">
        <div class="toolbar">
            <button class="run" onclick="runCode()">â–¶ å®Ÿè¡Œ</button>
            
            <label class="file-label" title="JSã¾ãŸã¯TXTãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€">
                ğŸ“‚ é–‹ã
                <input type="file" id="file-input" accept=".js,.txt" style="display:none" onchange="loadFile(this)">
            </label>

            <button onclick="toggleFS()" style="background:#d67f00;">å…¨ç”»é¢/VR</button>
        </div>
        
        <div class="slots">
            <script>
                for(let i=1; i<=5; i++) document.write(`<div style="display:contents"><button class="slot-btn save" onclick="saveS(${i})">S${i}</button><button class="slot-btn load" onclick="loadS(${i})">L${i}</button></div>`);
            </script>
        </div>
        
        <textarea id="code-editor" spellcheck="false" placeholder="// ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ã€ŒğŸ“‚é–‹ãã€ã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ãã ã•ã„">
// --- åˆæœŸã‚µãƒ³ãƒ—ãƒ« ---
const geo = new THREE.TorusKnotGeometry(1, 0.3, 100, 16);
const mat = new THREE.MeshNormalMaterial();
const mesh = new THREE.Mesh(geo, mat);
mesh.position.set(0, 1.6, -3);
scene.add(mesh);

function update(t) {
    mesh.rotation.x = t * 0.001;
    mesh.rotation.y = t * 0.002;
}
</textarea>
    </div>

    <div id="viewer-pane">
        <button id="close-btn" onclick="toggleFS()">âœ•</button>
        <div id="canvas-container" style="width:100%; height:100%;"></div>
    </div>
</div>

<script>
    let scene, camera, renderer, controls, updateFunc = null;

    // --- ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æ©Ÿèƒ½ ---
    function loadFile(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«æµã—è¾¼ã‚€
            document.getElementById('code-editor').value = e.target.result;
            // è‡ªå‹•çš„ã«å®Ÿè¡Œã™ã‚‹
            runCode();
            // inputã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸ã¹ã‚‹ã‚ˆã†ã«ï¼‰
            input.value = ''; 
        };
        reader.readAsText(file);
    }

    // --- ä»¥ä¸‹ã€åŸºæœ¬æ©Ÿèƒ½ ---
    function init() {
        if (typeof THREE === 'undefined') { setTimeout(init, 100); return; }
        
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.6, 5);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        renderer.shadowMap.enabled = true;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        if (typeof VRButton !== 'undefined') document.body.appendChild(VRButton.createButton(renderer));

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 1.6, 0);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));

        renderer.setAnimationLoop((time) => {
            if (updateFunc) try { updateFunc(time); } catch(e) {}
            controls.update();
            renderer.render(scene, camera);
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        runCode();
    }

    function runCode() {
        const code = document.getElementById('code-editor').value;
        for(let i = scene.children.length - 1; i >= 0; i--) {
            if(scene.children[i].type !== "AmbientLight") scene.remove(scene.children[i]);
        }
        updateFunc = null;
        try {
            const f = new Function('scene', 'camera', 'renderer', 'THREE', code + '\n return typeof update!=="undefined"?update:null;');
            updateFunc = f(scene, camera, renderer, THREE);
        } catch (e) { console.error(e); alert("Code Error: " + e.message); }
    }

    function toggleFS() { document.body.classList.toggle('fullscreen-mode'); }
    function saveS(n) { localStorage.setItem('slot_'+n, document.getElementById('code-editor').value); alert('Saved '+n); }
    function loadS(n) { const d = localStorage.getItem('slot_'+n); if(d) { document.getElementById('code-editor').value = d; runCode(); } }

    window.onload = init;
</script>
</body>
</html>
