<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>3Dコンテンツ動的ロードシステム (修正版)</title>
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; }
        #control-panel {
            width: 350px; padding: 15px; background-color: #f4f4f9;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; z-index: 10;
        }
        #code-input {
            flex-grow: 1; width: 100%; min-height: 200px; padding: 10px; margin-bottom: 10px;
            border: 1px solid #ccc; box-sizing: border-box; font-family: 'Consolas', 'Courier New', monospace; font-size: 12px; resize: vertical;
        }
        #run-button {
            padding: 10px; background-color: #3498db; color: white; border: none; cursor: pointer; font-size: 16px; border-radius: 4px; transition: background-color 0.2s;
        }
        #run-button:hover { background-color: #2980b9; }
        #three-container { flex-grow: 1; background-color: #87CEEB; position: relative; }
        #info { position: absolute; top: 10px; width: 100%; text-align: center; color: #333; font-size: 14px; pointer-events: none; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <div id="control-panel">
        <h3>3Dオブジェクトコード入力</h3>
        <p>「function 関数名(scene) { ... }」の形式でコードを貼り付けてください。</p>
        <textarea id="code-input" placeholder="コードをここに貼り付け..."></textarea>
        <button id="run-button">3D表示を更新</button>
    </div>

    <div id="three-container">
        <div id="info">OrbitControls (マウス操作) で視点変更が可能</div>
    </div>
    
    <script>
        let scene, camera, renderer, controls, animationFrameId;

        function initThreeScene(createContent) {
            const container = document.getElementById('three-container');
            if (renderer) {
                cancelAnimationFrame(animationFrameId);
                renderer.dispose();
                container.innerHTML = '<div id="info">OrbitControls (マウス操作) で視点変更が可能</div>';
                scene = null; camera = null; renderer = null; controls = null;
            }

            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x87CEEB, 20, 100);

            const width = container.clientWidth;
            const height = container.clientHeight;
            camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
            camera.position.set(30, 20, 40);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(50, 50, 30);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // コンテンツ生成関数を実行
            if (createContent) {
                try {
                    createContent(scene);
                } catch (e) {
                    alert("描画エラー: " + e.message);
                }
            }

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            function animate() {
                animationFrameId = requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            window.addEventListener('resize', () => {
                if (!camera || !renderer) return;
                const w = container.clientWidth, h = container.clientHeight;
                camera.aspect = w / h;
                camera.updateProjectionMatrix();
                renderer.setSize(w, h);
            });
        }
        
        document.getElementById('run-button').addEventListener('click', () => {
            const code = document.getElementById('code-input').value;
            try {
                // 正規表現で関数の中身（ボディ）だけを取り出す
                // 対応パターン: function 名前(scene) { ... }
                const match = code.match(/function\s+\w+\s*\(\s*scene\s*\)\s*\{([\s\S]*)\}/);
                
                if (!match || match.length < 2) {
                    alert('形式エラー: コードは "function 名前(scene) { ... }" の形で書いてください。');
                    return;
                }
                
                const functionBody = match[1];
                // sceneのみを引数にとり、グローバルのTHREEはそのまま参照させる
                const dynamicFunction = new Function('scene', functionBody);

                initThreeScene(dynamicFunction);

            } catch (e) {
                alert('コード読み込みエラー: ' + e.message);
            }
        });

        // デフォルトコードのセット（テスト用）
        const defaultCode = `
function createDemo(scene) {
    const geo = new THREE.BoxGeometry(5,5,5);
    const mat = new THREE.MeshStandardMaterial({color: 0xff0000});
    const mesh = new THREE.Mesh(geo, mat);
    mesh.position.y = 2.5;
    scene.add(mesh);
    
    const floor = new THREE.Mesh(new THREE.PlaneGeometry(20,20), new THREE.MeshStandardMaterial({color:0x999999}));
    floor.rotation.x = -Math.PI/2;
    scene.add(floor);
}
`;
        document.getElementById('code-input').value = defaultCode.trim();
        window.onload = () => document.getElementById('run-button').click();
    </script>
</body>
</html>
