<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D World Viewer - Pro</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; color: #fff; font-family: sans-serif; }
        #container { display: flex; height: 100vh; width: 100vw; }
        
        /* ã‚¨ãƒ‡ã‚£ã‚¿ã‚¨ãƒªã‚¢ */
        #editor-pane { width: 350px; background: #1e1e1e; display: flex; flex-direction: column; border-right: 1px solid #444; z-index: 10; transition: transform 0.3s ease; }
        
        /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
        .toolbar { padding: 8px; background: #252526; display: flex; flex-wrap: wrap; gap: 4px; align-items: center; border-bottom: 1px solid #333; }
        .toolbar button, .toolbar label { 
            background: #3a3a3a; color: #eee; border: 1px solid #555; padding: 6px 10px; 
            cursor: pointer; border-radius: 4px; font-size: 11px; font-weight: bold;
        }
        .toolbar button:active { transform: translateY(1px); }
        
        /* ãƒœã‚¿ãƒ³ã®è‰²åˆ†ã‘ */
        .btn-run { background: #0e639c; color: white; flex-grow: 2; border-color: #0e639c; font-size: 12px; }
        .btn-fs { background: #d67f00; color: white; border-color: #d67f00; flex-grow: 1; }
        .btn-action { background: #444; }
        .btn-clear { background: #6e3535; color: #ffcccc; } /* èµ¤ã¿ã‚’æŒãŸã›ã‚‹ */

        /* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›éš ã— */
        .file-label { background: #2d2d2d !important; }

        /* ã‚¹ãƒ­ãƒƒãƒˆã‚¨ãƒªã‚¢ */
        .slots { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; padding: 4px; background: #2d2d2d; }
        .slot-btn { font-size: 10px; padding: 4px; border: none; cursor: pointer; color: #ddd; }
        .save { background: #503030; } .load { background: #305035; }
        
        /* ã‚¨ãƒ‡ã‚£ã‚¿æœ¬ä½“ */
        #code-editor { flex-grow: 1; background: #1e1e1e; color: #d4d4d4; border: none; padding: 10px; font-family: monospace; font-size: 13px; outline: none; resize: none; white-space: pre; overflow-x: auto; }
        
        /* ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚¨ãƒªã‚¢ */
        #viewer-pane { flex-grow: 1; position: relative; }
        
        /* å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡ */
        body.fullscreen-mode #editor-pane { transform: translateX(-350px); width: 0; min-width: 0; }
        #close-btn { position: absolute; top: 15px; left: 15px; width: 44px; height: 44px; background: rgba(200, 50, 50, 0.8); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; font-size: 24px; cursor: pointer; display: none; z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        body.fullscreen-mode #close-btn { display: flex; }
    </style>
    
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/utils/WebVR.js"></script>
</head>
<body>

<div id="container">
    <div id="editor-pane">
        <div class="toolbar">
            <button class="btn-run" onclick="runCode()">â–¶ å®Ÿè¡Œ (Run)</button>
            <button class="btn-fs" onclick="toggleFS()">å…¨ç”»é¢/VR</button>
        </div>
        <div class="toolbar" style="padding-top:0;">
            <label class="file-label" title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã">ğŸ“‚<input type="file" onchange="loadFile(this)" style="display:none"></label>
            <button class="btn-action" onclick="copyCode()">Copy</button>
            <button class="btn-action" onclick="pasteCode()">Paste(New)</button>
            <button class="btn-clear" onclick="clearCode()">Clear</button>
        </div>
        
        <div class="slots">
            <script>
                for(let i=1; i<=5; i++) document.write(`<div style="display:contents"><button class="slot-btn save" onclick="saveS(${i})">Save${i}</button><button class="slot-btn load" onclick="loadS(${i})">Load${i}</button></div>`);
            </script>
        </div>
        
        <textarea id="code-editor" spellcheck="false" placeholder="// Pasteãƒœã‚¿ãƒ³ã§ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã‹ã€ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„...">
// --- åˆæœŸã‚µãƒ³ãƒ—ãƒ« ---
const geo = new THREE.TorusKnotGeometry(1, 0.3, 100, 16);
const mat = new THREE.MeshNormalMaterial();
const mesh = new THREE.Mesh(geo, mat);
mesh.position.set(0, 1.6, -3);
scene.add(mesh);

function update(t) {
    mesh.rotation.x = t * 0.001;
    mesh.rotation.y = t * 0.002;
}
</textarea>
    </div>

    <div id="viewer-pane">
        <button id="close-btn" onclick="toggleFS()">âœ•</button>
        <div id="canvas-container" style="width:100%; height:100%;"></div>
    </div>
</div>

<script>
    let scene, camera, renderer, controls, updateFunc = null;

    // --- UI ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
    
    // 1. ã‚³ãƒ”ãƒ¼
    function copyCode() {
        const t = document.getElementById('code-editor');
        t.select();
        navigator.clipboard.writeText(t.value).then(() => alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
    }

    // 2. ãƒšãƒ¼ã‚¹ãƒˆï¼ˆã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰è²¼ã‚Šä»˜ã‘ï¼‰
    async function pasteCode() {
        try {
            const text = await navigator.clipboard.readText();
            const editor = document.getElementById('code-editor');
            editor.value = ''; // ã¾ãšã‚¯ãƒªã‚¢
            editor.value = text; // è²¼ã‚Šä»˜ã‘
            // runCode(); // â€»ãŠå¥½ã¿ã§è‡ªå‹•å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã™
        } catch(e) {
            alert('ãƒšãƒ¼ã‚¹ãƒˆæ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
        }
    }

    // 3. ã‚¯ãƒªã‚¢
    function clearCode() {
        if(confirm('ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) {
            document.getElementById('code-editor').value = '';
        }
    }

    // 4. å…¨ç”»é¢ï¼ˆå®Ÿè¡Œã—ã¦ã‹ã‚‰åˆ‡ã‚Šæ›¿ãˆï¼‰
    function toggleFS() {
        // å…¨ç”»é¢ã«ãªã‚‹å‰ã«ã€ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã‚’åæ˜ ã•ã›ã‚‹
        if (!document.body.classList.contains('fullscreen-mode')) {
            runCode();
        }
        document.body.classList.toggle('fullscreen-mode');
        // ãƒªã‚µã‚¤ã‚ºèª¿æ•´å¾…ã¡
        setTimeout(() => {
            const w = document.getElementById('viewer-pane').clientWidth;
            const h = document.getElementById('viewer-pane').clientHeight;
            if(camera && renderer) {
                camera.aspect = w / h;
                camera.updateProjectionMatrix();
                renderer.setSize(w, h);
            }
        }, 350);
    }

    // 5. ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    function loadFile(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('code-editor').value = e.target.result;
            runCode();
            input.value = ''; 
        };
        reader.readAsText(file);
    }

    // --- Three.js åˆæœŸåŒ– & å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ ---
    function init() {
        if (typeof THREE === 'undefined') { setTimeout(init, 100); return; }
        
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.6, 5);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        renderer.shadowMap.enabled = true;
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        if (typeof VRButton !== 'undefined') document.body.appendChild(VRButton.createButton(renderer));

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 1.6, 0);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));

        renderer.setAnimationLoop((time) => {
            if (updateFunc) try { updateFunc(time); } catch(e) {}
            controls.update();
            renderer.render(scene, camera);
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        runCode();
    }

    function runCode() {
        const code = document.getElementById('code-editor').value;
        // ãƒ©ã‚¤ãƒˆä»¥å¤–ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªã‚¢
        for(let i = scene.children.length - 1; i >= 0; i--) {
            if(scene.children[i].type !== "AmbientLight") scene.remove(scene.children[i]);
        }
        updateFunc = null;
        try {
            const f = new Function('scene', 'camera', 'renderer', 'THREE', code + '\n return typeof update!=="undefined"?update:null;');
            updateFunc = f(scene, camera, renderer, THREE);
        } catch (e) { console.error(e); alert("ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: " + e.message); }
    }
    
    function saveS(n) { localStorage.setItem('slot_'+n, document.getElementById('code-editor').value); alert('Saved Slot '+n); }
    function loadS(n) { const d = localStorage.getItem('slot_'+n); if(d) { document.getElementById('code-editor').value = d; runCode(); } }

    window.onload = init;
</script>
</body>
</html>
