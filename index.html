<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WebXR 3D Editor</title>
    <style>
        /* ベーススタイル */
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #121212; color: #ddd; }
        
        /* レイアウト */
        #container { display: flex; height: 100%; width: 100%; transition: transform 0.3s ease; }
        
        /* 左側：エディタペイン */
        #editor-pane {
            width: 40%; 
            min-width: 320px;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            border-right: 1px solid #333;
            z-index: 20;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
        }

        /* モバイル対応：エディタ幅調整 */
        @media (max-width: 600px) {
            #editor-pane { width: 100%; max-width: none; position: absolute; height: 100%; }
        }

        /* ツールバー */
        .toolbar { padding: 8px; background: #252526; display: flex; flex-wrap: wrap; gap: 6px; align-items: center; border-bottom: 1px solid #333; }
        .toolbar button {
            background: #3a3a3a; color: #eee; border: 1px solid #444; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 13px; font-weight: 500; transition: background 0.2s;
        }
        .toolbar button:active { transform: translateY(1px); }
        .toolbar button.primary { background: #0e639c; border-color: #0e639c; color: white; flex-grow: 1; }
        .toolbar button.view-mode { background: #d67f00; border-color: #d67f00; color: white; }

        /* スロットエリア */
        .slots { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; padding: 6px; background: #2d2d2d; border-bottom: 1px solid #333; }
        .slot-group { display: flex; flex-direction: column; gap: 2px; }
        .slot-btn { font-size: 10px; padding: 4px; border: none; cursor: pointer; color: #ddd; border-radius: 2px; }
        .save-btn { background: #5a3e3e; } .save-btn:hover { background: #7a4e4e; }
        .load-btn { background: #3e5a46; } .load-btn:hover { background: #4e7a56; }

        /* エディタ */
        #code-editor {
            flex-grow: 1; background: #1e1e1e; color: #d4d4d4; border: none; padding: 12px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 13px; line-height: 1.5;
            resize: none; outline: none; white-space: pre; overflow-x: auto;
        }

        /* 右側：3Dビューワー */
        #viewer-pane { flex-grow: 1; position: relative; background: #000; overflow: hidden; }
        #canvas-container { width: 100%; height: 100%; display: block; }

        /* 全画面・VRモード時のスタイル */
        body.fullscreen-mode #editor-pane { margin-left: -100vw; } /* 画面外へスライド */
        
        /* 戻るボタン（×） */
        #close-fullscreen {
            position: absolute; top: 20px; left: 20px; width: 44px; height: 44px;
            background: rgba(40, 40, 40, 0.8); color: #fff; border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%; font-size: 24px; cursor: pointer; display: none;
            z-index: 100; align-items: center; justify-content: center;
            backdrop-filter: blur(4px); box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        #close-fullscreen:hover { background: rgba(200, 50, 50, 0.9); border-color: white; }
        body.fullscreen-mode #close-fullscreen { display: flex; }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/WebVR.js"></script>
</head>
<body>

<div id="container">
    <div id="editor-pane">
        <div class="toolbar">
            <button class="primary" onclick="runCode()">▶ 実行 (Run)</button>
            <button onclick="copyCode()">Copy</button>
            <button onclick="pasteCode()">Paste</button>
            <button class="view-mode" onclick="toggleFullScreen()">全画面 / VRへ</button>
        </div>
        <div class="slots">
            <script>
                for(let i=1; i<=5; i++){
                    document.write(`<div class="slot-group">
                        <button class="slot-btn save-btn" onclick="saveSlot(${i})">Save${i}</button>
                        <button class="slot-btn load-btn" onclick="loadSlot(${i})">Load${i}</button>
                    </div>`);
                }
            </script>
        </div>
        <textarea id="code-editor" spellcheck="false" placeholder="// ここにThree.jsコードを入力...">
// Sample: Spinning Cube
const geometry = new THREE.BoxGeometry(1, 1, 1);
const material = new THREE.MeshNormalMaterial();
const cube = new THREE.Mesh(geometry, material);
cube.position.y = 1.6; // VR Eye Height
scene.add(cube);

function update(time) {
    cube.rotation.x = time * 0.001;
    cube.rotation.y = time * 0.002;
}
</textarea>
    </div>

    <div id="viewer-pane">
        <button id="close-fullscreen" onclick="toggleFullScreen()">✕</button>
        <div id="canvas-container"></div>
    </div>
</div>

<script>
    let scene, camera, renderer, controls, updateFunc = null;
    const container = document.getElementById('canvas-container');

    function init() {
        // シーン
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x101010);

        // カメラ（VR標準の目の高さ1.6mを考慮して初期配置）
        camera = new THREE.PerspectiveCamera(70, container.clientWidth / container.clientHeight, 0.1, 500);
        camera.position.set(0, 1.6, 4);

        // レンダラー
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.xr.enabled = true; // WebXR有効化
        renderer.shadowMap.enabled = true; // 影有効化
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // VRボタン（画面右下に自動配置される）
        document.body.appendChild(VRButton.createButton(renderer));

        // PC/スマホ操作用コントロール
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 1.6, 0);
        controls.update();

        // アニメーションループ (VR対応)
        renderer.setAnimationLoop(function (time) {
            if (updateFunc) {
                try {
                    updateFunc(time);
                } catch(e) {
                    console.error(e);
                    // エラーが出たらループを止めてアラート（無限ループ防止）
                    updateFunc = null; 
                }
            }
            controls.update();
            renderer.render(scene, camera);
        });
        
        // リサイズ処理
        window.addEventListener('resize', onWindowResize);
        
        // 初回実行
        runCode();
    }

    function runCode() {
        const code = document.getElementById('code-editor').value;
        
        // クリーンアップ
        while(scene.children.length > 0){ scene.remove(scene.children[0]); }
        updateFunc = null;

        try {
            // Functionコンストラクタで実行環境を作る
            // scene, camera, renderer, THREE をAI生成コードに渡す
            const createScene = new Function('scene', 'camera', 'renderer', 'THREE', code + '\n return typeof update !== "undefined" ? update : null;');
            
            const result = createScene(scene, camera, renderer, THREE);
            if (typeof result === 'function') {
                updateFunc = result;
            }
        } catch (e) {
            alert("コードエラー:\n" + e.message);
        }
    }

    function onWindowResize() {
        const w = document.getElementById('viewer-pane').clientWidth;
        const h = document.getElementById('viewer-pane').clientHeight;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
    }

    // UI機能
    function toggleFullScreen() {
        document.body.classList.toggle('fullscreen-mode');
        setTimeout(onWindowResize, 350); // アニメーション後にリサイズ
    }

    function copyCode() {
        const t = document.getElementById('code-editor');
        t.select(); navigator.clipboard.writeText(t.value).then(()=>alert('Copied!'));
    }
    
    async function pasteCode() {
        try {
            const txt = await navigator.clipboard.readText();
            document.getElementById('code-editor').value = txt;
        } catch(e) { alert('Paste permission denied'); }
    }

    function saveSlot(n) {
        localStorage.setItem('vr_viewer_slot_' + n, document.getElementById('code-editor').value);
        alert(`Slot ${n} Saved`);
    }
    
    function loadSlot(n) {
        const d = localStorage.getItem('vr_viewer_slot_' + n);
        if(d) { document.getElementById('code-editor').value = d; runCode(); }
        else { alert('Slot is empty'); }
    }

    init();
</script>
</body>
</html>
