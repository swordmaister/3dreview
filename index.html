<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebVR Advanced Controller Demo</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    /* PC/スマホ用UIのスタイル */
    #overlay-ui {
      position: fixed; bottom: 20px; left: 20px; z-index: 999;
      background: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 10px;
      font-family: sans-serif; pointer-events: none; /* UIへの操作を透過させる */
    }
    #debug-log {
      font-family: monospace; color: #0f0;
    }
  </style>
</head>
<body>

  <div id="overlay-ui">
    <h3>デバッグモニター</h3>
    <div id="debug-log">ボタン入力待機中...</div>
    <hr>
    <small>
      【PCでのトラッキング模倣操作】<br>
      VRモード外で有効。<br>
      矢印キー: 左手移動<br>
      I/J/K/Lキー: 右手移動
    </small>
  </div>


  <a-scene background="color: #ECECEC">

    <a-entity id="rig" position="0 1.6 0">

      <a-camera position="0 0 0" look-controls="enabled: true"></a-camera>


      <a-entity id="leftHand"
                oculus-touch-controls="hand: left; model: true"
                full-controller-listener="hand: left">
        
        <a-box color="red" depth="0.05" height="0.05" width="0.05" position="0 -0.05 0.1"></a-box>

        <a-axes length="0.1" position="0 0 0"></a-axes>
      </a-entity>


      <a-entity id="rightHand"
                oculus-touch-controls="hand: right; model: true"
                full-controller-listener="hand: right">
        
        <a-sphere color="blue" radius="0.03" position="0 -0.05 0.1"></a-sphere>

        <a-axes length="0.1" position="0 0 0"></a-axes>
      </a-entity>

    </a-entity> <a-grid material="src: url(https://cdn.aframe.io/a-painter/images/floor.jpg); repeat: 50 50" geometry="width: 50; height: 50"></a-grid>
    <a-sky color="#88c"></a-sky>

  </a-scene>


  <script>
    /**
     * ログ出力用ヘルパー関数
     */
    const logEl = document.getElementById('debug-log');
    function log(msg) {
      logEl.textContent = msg;
      console.log(msg);
      // ログを一定時間で消すタイマー設定（任意）
      if (window.logTimer) clearTimeout(window.logTimer);
      window.logTimer = setTimeout(() => { logEl.textContent = "待機中..."; }, 2000);
    }


    /**
     * ■ 拡張コントローラーリスナーコンポーネント
     * メタクエストの主要な全ボタンを監視します。
     */
    AFRAME.registerComponent('full-controller-listener', {
      schema: {
        hand: {type: 'string', default: 'right'} // left か right を指定
      },

      init: function () {
        const el = this.el;
        const handLabel = this.data.hand === 'left' ? '【左手】' : '【右手】';

        // --- イベントリスナー登録 ---

        // 1. トリガー（人差し指）
        el.addEventListener('triggerdown', () => log(`${handLabel} トリガーを引いた！`));
        el.addEventListener('triggerup', () => log(`${handLabel} トリガーを離した`));

        // 2. グリップ（中指）
        el.addEventListener('gripdown', () => log(`${handLabel} グリップを握った！`));
        el.addEventListener('gripup', () => log(`${handLabel} グリップを離した`));

        // 3. A/X ボタン
        el.addEventListener('abuttondown', () => log(`${handLabel} A/XボタンDOWN`));
        el.addEventListener('xbuttondown', () => log(`${handLabel} A/XボタンDOWN`));

        // 4. B/Y ボタン
        el.addEventListener('bbuttondown', () => log(`${handLabel} B/YボタンDOWN`));
        el.addEventListener('ybuttondown', () => log(`${handLabel} B/YボタンDOWN`));

        // 5. スティック押し込み
        el.addEventListener('thumbstickdown', () => log(`${handLabel} スティック押し込み！`));

        // 6. スティックの傾き（アナログ値）
        el.addEventListener('thumbstickmoved', (evt) => {
          const {x, y} = evt.detail;
          // 感度調整のため、一定以上傾けた時だけ反応させる
          if (Math.abs(x) > 0.5 || Math.abs(y) > 0.5) {
            log(`${handLabel} スティック移動: X=${x.toFixed(2)}, Y=${y.toFixed(2)}`);
          }
        });
        
        // 7. タッチセンサー（指が触れただけ）の例
        el.addEventListener('thumbsticktouchstart', () => log(`${handLabel} スティックに触れた`));
      }
    });


    /**
     * ■ トラッキング模倣システム（PCキーボード用）
     * VRモード外の時に、キーボードで擬似ハンドを動かします。
     */
    (function setupKeyboardTrackingSimulation() {
      const leftHand = document.getElementById('leftHand');
      const rightHand = document.getElementById('rightHand');
      const scene = document.querySelector('a-scene');
      let isVR = false;

      // 擬似的な手の位置
      let leftPos = {x: -0.3, y: 1.2, z: -0.5};
      let rightPos = {x: 0.3, y: 1.2, z: -0.5};
      const moveStep = 0.05; // 1回のキー押しでの移動量

      // VRモード切替検知
      scene.addEventListener('enter-vr', () => { isVR = true; });
      scene.addEventListener('exit-vr', () => { isVR = false; });

      // 初期位置合わせ
      leftHand.setAttribute('position', leftPos);
      rightHand.setAttribute('position', rightPos);
      // PCモードではコントローラーモデルが見えないことがあるので強制表示設定
      leftHand.setAttribute('visible', 'true');
      rightHand.setAttribute('visible', 'true');


      // キーボード監視
      window.addEventListener('keydown', (e) => {
        // VRモード中は本来のトラッキングを邪魔しないように動かさない
        if (isVR) return; 

        let moved = false;

        // --- 左手操作 (矢印キー) ---
        if (e.key === 'ArrowLeft')  { leftPos.x -= moveStep; moved = true; }
        if (e.key === 'ArrowRight') { leftPos.x += moveStep; moved = true; }
        if (e.key === 'ArrowUp')    { leftPos.y += moveStep; moved = true; }
        if (e.key === 'ArrowDown')  { leftPos.y -= moveStep; moved = true; }
        // Z軸移動(Shift+上下)の例
        if (e.shiftKey && e.key === 'ArrowUp')   { leftPos.z -= moveStep; moved = true; e.preventDefault(); }
        if (e.shiftKey && e.key === 'ArrowDown') { leftPos.z += moveStep; moved = true; e.preventDefault(); }


        // --- 右手操作 (I/J/K/Lキー) ---
        if (e.key === 'j' || e.key === 'J') { rightPos.x -= moveStep; moved = true; }
        if (e.key === 'l' || e.key === 'L') { rightPos.x += moveStep; moved = true; }
        if (e.key === 'i' || e.key === 'I') { rightPos.y += moveStep; moved = true; }
        if (e.key === 'k' || e.key === 'K') { rightPos.y -= moveStep; moved = true; }
        // Z軸移動(Shift+I/K)の例
        if (e.shiftKey && (e.key === 'i' || e.key === 'I')) { rightPos.z -= moveStep; moved = true; }
        if (e.shiftKey && (e.key === 'k' || e.key === 'K')) { rightPos.z += moveStep; moved = true; }

        // 位置更新
        if (moved) {
          leftHand.setAttribute('position', leftPos);
          rightHand.setAttribute('position', rightPos);
          log('PC模倣: 手の位置を更新しました');
        }
      });
    })();

  </script>
</body>
</html>
