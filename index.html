<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>3Dコンテンツ動的ロードシステム</title>
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; }
        
        /* 1. コントロールパネル (左側) */
        #control-panel {
            width: 350px;
            padding: 15px;
            background-color: #f4f4f9;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            z-index: 10;
        }
        
        /* テキストエリア */
        #code-input {
            flex-grow: 1; /* 残りのスペースを全て使用 */
            width: 100%;
            min-height: 200px; /* 初期高さを確保 */
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        /* 実行ボタン */
        #run-button {
            padding: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        #run-button:hover {
            background-color: #2980b9;
        }

        /* 2. 3D描画エリア (右側) */
        #three-container {
            flex-grow: 1; /* 残りのスペースを全て使用 */
            background-color: #87CEEB;
            position: relative;
        }
        
        /* 情報表示 */
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: #333;
            font-size: 14px;
            pointer-events: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

    <div id="control-panel">
        <h3>3Dオブジェクトコード入力</h3>
        <p>
            下のエリアに、Three.jsでシーンにオブジェクトを追加するJavaScript関数（例: <code>function createContent(scene) { ... }</code>）を貼り付けてください。
        </p>
        <textarea id="code-input" placeholder="ここにJavaScriptコードを貼り付けます..."></textarea>
        <button id="run-button">3D表示を更新</button>
        <p style="font-size: 10px; color: #777; margin-top: 5px;">
            ※セキュリティ上の理由から、この手法はローカル環境でのテスト用としてご利用ください。
        </p>
    </div>

    <div id="three-container">
        <div id="info">OrbitControls (マウス操作) で視点変更が可能</div>
    </div>
    
    <script>
        // グローバル変数としてシーンを保持（リロード用）
        let scene, camera, renderer, controls;
        let animationFrameId;

        // --- 描画フレームワーク (前回とほぼ同じ) ---

        /**
         * Three.jsシーンを初期化し、描画ループを開始する関数。
         * 以前のシーンがあれば破棄して再作成します。
         * @param {function} createContent - シーンにオブジェクトを追加する関数。
         */
        function initThreeScene(createContent) {
            const container = document.getElementById('three-container');

            // 既存のシーンを破棄（リロード処理）
            if (renderer) {
                cancelAnimationFrame(animationFrameId);
                renderer.dispose();
                container.innerHTML = '<div id="info">OrbitControls (マウス操作) で視点変更が可能</div>';
                scene = null;
                camera = null;
                renderer = null;
                controls = null;
            }

            // 1. シーン、カメラ、レンダラーのセットアップ
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x87CEEB, 20, 100);

            const width = container.clientWidth;
            const height = container.clientHeight;
            
            camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
            camera.position.set(30, 20, 40);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            // 2. ライトの設定
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(50, 50, 30);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // 3. ユーザー定義のコンテンツを作成・追加
            if (createContent) {
                 // **重要**: ここで外部から渡された関数を実行し、3Dモデルを描画
                createContent(scene);
            }


            // 4. コントロール
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // 5. アニメーションループ
            function animate() {
                animationFrameId = requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            // 6. ウィンドウリサイズ対応
            window.addEventListener('resize', onWindowResize);
        }

        function onWindowResize() {
            if (camera && renderer) {
                const container = document.getElementById('three-container');
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        }
        
        // --- 実行ロジック ---

        document.getElementById('run-button').addEventListener('click', () => {
            const code = document.getElementById('code-input').value;
            
            // ユーザーコードを動的に実行するためのコンテナ関数
            let dynamicFunction = null;

            try {
                // eval() または Functionコンストラクタを使用して文字列を関数として実行
                // ただし、Three.jsオブジェクトがスコープ内にある必要がある
                // ここではFunctionコンストラクタを使用し、引数にTHREEを渡す安全な方法を採用

                // ユーザーが 'function createContent(scene) { ... }' の形でコードを貼り付けることを想定
                
                // 1. 関数本体（ボディ）を抽出
                const match = code.match(/function\s+\w+\s*\(\s*scene\s*\)\s*\{([\s\S]*)\}/);

                if (!match || match.length < 2) {
                    alert('エラー: "function 関数名(scene) { ... }" の形式でコードを貼り付けてください。');
                    return;
                }
                
                const functionBody = match[1];

                // 2. 新しい関数を動的に作成 (引数: scene)
                // この方法により、ユーザーコード内で THREE.XXX を安全に使用できます
                dynamicFunction = new Function('scene', 'THREE', functionBody);


                // 3. Three.jsシーンをリセットし、新しいコンテンツをロード
                initThreeScene(scene => {
                    // THREEを引数として渡し、関数を実行
                    dynamicFunction(scene, THREE);
                });

            } catch (e) {
                alert('コードの実行中にエラーが発生しました: ' + e.message);
                console.error(e);
            }
        });
        
        // --- 初期コンテンツの設定（テスト用） ---
        
        // 前回の城のコードをデフォルトとして入力エリアに設定
        const defaultCastleCode = `
function createCastle(scene) {
    // この関数を自由に書き換えてください。
    // THREE.XXX はそのまま使用できます。
    const wallMaterial = new THREE.MeshStandardMaterial({ color: 0xf3f3f3 });
    const roofMaterial = new THREE.MeshStandardMaterial({ color: 0x2c3e50 });
    const grassMaterial = new THREE.MeshStandardMaterial({ color: 0x558855 });
    
    // メインブロック
    const mainBlock = new THREE.Mesh(new THREE.BoxGeometry(10, 8, 6), wallMaterial);
    mainBlock.position.y = 4;
    mainBlock.castShadow = true;
    scene.add(mainBlock);
    
    // 塔
    const tower = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.5, 15, 16), wallMaterial);
    tower.position.set(6, 7.5, 2);
    tower.castShadow = true;
    scene.add(tower);
    
    // 塔の屋根
    const roof = new THREE.Mesh(new THREE.ConeGeometry(2, 4, 16), roofMaterial);
    roof.position.set(6, 17, 2);
    roof.castShadow = true;
    scene.add(roof);

    // 土台
    const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), grassMaterial);
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);
}
`;

        document.getElementById('code-input').value = defaultCastleCode.trim();

        // ページロード時にデフォルトの城を描画
        window.onload = () => {
            // run-button のクリックイベントをシミュレート
            document.getElementById('run-button').click(); 
        };
    </script>
</body>
</html>
